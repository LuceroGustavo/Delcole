<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administración - Kiosco Delcole</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0..1,0" rel="stylesheet">
    <link th:href="@{/css/app.css}" rel="stylesheet">
    <style>
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; font-size: 20px; }
        .admin-card { border-radius: 12px; border: none; box-shadow: 0 2px 12px rgba(0,0,0,.08); }
    </style>
</head>
<body class="bg-light">
    <div th:replace="~{fragments/navbar :: nav}"></div>
    <main class="container py-4">
        <a th:href="@{/}" class="btn btn-link text-muted text-decoration-none p-0 mb-3">← Volver al inicio</a>
        <h4 class="mb-4">⚙️ Administración</h4>

        <!-- Cambiar contraseña -->
        <section id="cambiar-password" class="card admin-card mb-4">
            <div class="card-header bg-white fw-semibold">
                <span class="material-symbols-outlined align-middle me-2">lock</span> Cambiar contraseña
            </div>
            <div class="card-body">
                <div th:if="${errorPassword}" class="alert alert-danger py-2 small" th:text="${errorPassword}">Error</div>
                <div th:if="${okPassword}" class="alert alert-success py-2 small" th:text="${okPassword}">Ok</div>
                <form th:action="@{/admin/cambiar-password}" method="post" class="mb-0">
                    <div class="mb-2">
                        <label class="form-label small">Contraseña actual</label>
                        <input type="password" name="contraseñaActual" class="form-control" required placeholder="••••••••" autocomplete="current-password" />
                    </div>
                    <div class="mb-2">
                        <label class="form-label small">Nueva contraseña</label>
                        <input type="password" name="contraseñaNueva" class="form-control" required minlength="4" placeholder="••••••••" autocomplete="new-password" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label small">Repetir nueva contraseña</label>
                        <input type="password" name="contraseñaNueva2" class="form-control" required minlength="4" placeholder="••••••••" autocomplete="new-password" />
                    </div>
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <button type="submit" class="btn btn-primary">Guardar nueva contraseña</button>
                </form>
            </div>
        </section>

        <!-- Ingreso por huella -->
        <section id="huella" class="card admin-card mb-4">
            <div class="card-header bg-white fw-semibold">
                <span class="material-symbols-outlined align-middle me-2">fingerprint</span> Ingreso por huella
            </div>
            <div class="card-body">
                <p class="small text-muted mb-3">
                    En la versión para celular podrás iniciar sesión con tu huella. Activa la opción para usarla cuando la app móvil lo soporte.
                </p>
                <div th:if="${okHuella}" class="alert alert-success py-2 small" th:text="${okHuella}">Ok</div>
                <form th:action="@{/admin/huella}" method="post" id="formHuella">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <input type="hidden" name="habilitada" id="huellaHabilitadaValue" value="" />
                    <div class="form-check form-switch">
                        <input type="checkbox" class="form-check-input" id="huellaHabilitada" th:checked="${huellaActiva}" />
                        <label class="form-check-label" for="huellaHabilitada">Activar ingreso por huella (en la app móvil)</label>
                    </div>
                </form>
            </div>
        </section>

        <!-- Crear usuarios -->
        <section id="crear-usuario" class="card admin-card mb-4">
            <div class="card-header bg-white fw-semibold">
                <span class="material-symbols-outlined align-middle me-2">person_add</span> Crear usuario
            </div>
            <div class="card-body">
                <div th:if="${errorUsuario}" class="alert alert-danger py-2 small" th:text="${errorUsuario}">Error</div>
                <div th:if="${okUsuario}" class="alert alert-success py-2 small" th:text="${okUsuario}">Ok</div>
                <form th:action="@{/admin/usuarios}" method="post" class="mb-4">
                    <div class="row g-2">
                        <div class="col-12 col-md-4">
                            <label class="form-label small">Usuario</label>
                            <input type="text" name="username" class="form-control" required placeholder="nombre" />
                        </div>
                        <div class="col-6 col-md-2">
                            <label class="form-label small">Contraseña</label>
                            <input type="password" name="password" class="form-control" required minlength="4" placeholder="••••" />
                        </div>
                        <div class="col-6 col-md-2">
                            <label class="form-label small">Repetir</label>
                            <input type="password" name="password2" class="form-control" required minlength="4" placeholder="••••" />
                        </div>
                        <div class="col-8 col-md-2">
                            <label class="form-label small">Rol</label>
                            <select name="rol" class="form-select">
                                <option th:each="r : ${roles}" th:value="${r.name()}" th:text="${r.name()}">Rol</option>
                            </select>
                        </div>
                        <div class="col-4 col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-success w-100">Crear</button>
                        </div>
                    </div>
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                </form>
                <h6 class="small fw-semibold text-muted mb-2">Usuarios existentes</h6>
                <ul class="list-group list-group-flush">
                    <li th:each="u : ${usuarios}" class="list-group-item d-flex justify-content-between align-items-center px-0">
                        <span><strong th:text="${u.username}">user</strong> <span class="badge bg-secondary ms-1" th:text="${u.rol}">Rol</span></span>
                        <span th:if="${u != null and u.huellaHabilitada}" class="badge bg-info">Huella activa</span>
                    </li>
                </ul>
            </div>
        </section>
    </main>

    <!-- Modal confirmación ingreso por huella -->
    <div class="modal fade" id="modalConfirmarHuella" tabindex="-1" aria-labelledby="modalConfirmarHuellaLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalConfirmarHuellaLabel">
                        <span class="material-symbols-outlined align-middle me-2">fingerprint</span>
                        <span id="modalConfirmarHuellaTitulo">Confirmar</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body" id="modalConfirmarHuellaCuerpo">
                    ¿Activar ingreso por huella? Podrás usar tu huella para iniciar sesión cuando la app móvil lo soporte.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="btnCancelarHuella">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btnConfirmarHuella">Aceptar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        (function() {
            var form = document.getElementById('formHuella');
            var check = document.getElementById('huellaHabilitada');
            var hiddenHab = document.getElementById('huellaHabilitadaValue');
            var modal = new bootstrap.Modal(document.getElementById('modalConfirmarHuella'));
            var titulo = document.getElementById('modalConfirmarHuellaTitulo');
            var cuerpo = document.getElementById('modalConfirmarHuellaCuerpo');
            var btnConfirmar = document.getElementById('btnConfirmarHuella');
            var btnCancelar = document.getElementById('btnCancelarHuella');

            check.addEventListener('change', function() {
                if (check.checked) {
                    titulo.textContent = 'Activar ingreso por huella';
                    cuerpo.textContent = '¿Activar ingreso por huella? Podrás usar tu huella para iniciar sesión cuando la app móvil lo soporte.';
                    btnConfirmar.textContent = 'Aceptar';
                } else {
                    titulo.textContent = 'Desactivar ingreso por huella';
                    cuerpo.textContent = '¿Desactivar ingreso por huella? Deberás usar usuario y contraseña para iniciar sesión.';
                    btnConfirmar.textContent = 'Aceptar';
                }
                modal.show();
            });

            btnConfirmar.addEventListener('click', function() {
                hiddenHab.value = check.checked ? 'true' : 'false';
                form.submit();
            });

            document.getElementById('modalConfirmarHuella').addEventListener('hidden.bs.modal', function() {
                if (!form.dataset.submitted) {
                    check.checked = !check.checked;
                }
            });

            form.addEventListener('submit', function() { form.dataset.submitted = '1'; });
        })();
    </script>
</body>
</html>
