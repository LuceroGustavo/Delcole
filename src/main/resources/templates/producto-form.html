<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${titulo}">Agregar producto</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .scanner-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1050;
        }
        .scanner-overlay.activo { display: flex; }
        .scanner-modal {
            background: #000;
            border-radius: 8px;
            max-width: 500px;
            width: 100%;
            padding: 0.5rem;
            color: #fff;
        }
        #scannerViewport { width: 100%; max-height: 50vh; }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-primary mb-3">
        <div class="container-fluid">
            <a class="navbar-brand" th:href="@{/productos}">‚Üê Productos</a>
        </div>
    </nav>
    <main class="container">
        <h4 class="mb-4" th:text="${titulo}">Agregar producto</h4>
        <form th:action="@{/api/productos}" th:object="${producto}" method="post" id="formProducto">
            <div class="mb-3">
                <label class="form-label">C√≥digo de barras (opcional)</label>
                <div class="input-group">
                    <input type="text" id="codigoBarra" class="form-control form-control-lg" th:field="*{codigoBarra}" placeholder="Escanear o escribir el c√≥digo">
                    <button type="button" id="btnEscanearCodigo" class="btn btn-outline-primary">üì∑ Escanear</button>
                </div>
                <div class="form-text small">Si la c√°mara no lee bien, us√° una app de escaneo y peg√° el c√≥digo ac√°.</div>
            </div>
            <div class="mb-3">
                <label class="form-label">Nombre *</label>
                <input type="text" class="form-control form-control-lg" th:field="*{nombre}" required placeholder="Nombre del producto">
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Precio de compra</label>
                    <input type="number" step="0.01" class="form-control form-control-lg" th:field="*{precioCompra}" placeholder="0.00">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Precio de venta *</label>
                    <input type="number" step="0.01" class="form-control form-control-lg" th:field="*{precioVenta}" required placeholder="0.00">
                </div>
            </div>
            <div class="row">
                <div class="col-6 mb-3">
                    <label class="form-label">Stock inicial</label>
                    <input type="number" class="form-control form-control-lg" th:field="*{stockActual}" min="0" placeholder="0">
                </div>
                <div class="col-6 mb-3">
                    <label class="form-label">Stock m√≠nimo (alerta)</label>
                    <input type="number" class="form-control form-control-lg" th:field="*{stockMinimo}" min="0" placeholder="0">
                </div>
            </div>
            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                <a th:href="@{/productos}" class="btn btn-outline-secondary btn-lg">Cancelar</a>
                <button type="submit" class="btn btn-success btn-lg">Guardar</button>
            </div>
        </form>
    </main>

    <!-- Overlay esc√°ner para c√≥digo de barras -->
    <div id="scannerOverlay" class="scanner-overlay">
        <div class="scanner-modal">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="fw-semibold">Escanear c√≥digo de barras</span>
                <button type="button" id="btnCerrarScanner" class="btn btn-sm btn-light">Cerrar</button>
            </div>
            <div id="scannerMensaje" class="small mb-1" style="min-height: 1.2em;"></div>
            <div id="scannerViewport"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/@ericblade/quagga2/dist/quagga.js"></script>
    <script>
        document.getElementById('formProducto').addEventListener('submit', function(e) {
            e.preventDefault();
            const form = e.target;
            const data = {
                codigoBarra: form.codigoBarra.value || null,
                nombre: form.nombre.value,
                precioCompra: form.precioCompra.value ? parseFloat(form.precioCompra.value) : null,
                precioVenta: parseFloat(form.precioVenta.value) || 0,
                stockActual: parseInt(form.stockActual.value) || 0,
                stockMinimo: parseInt(form.stockMinimo.value) || 0,
                activo: true
            };
            fetch(form.action, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(r => r.ok ? r.json() : Promise.reject(r))
            .then(() => { window.location.href = '/productos'; })
            .catch(() => alert('Error al guardar. Revis√° los datos.'));
        });

        // --- Escanear c√≥digo de barras en nuevo producto ---
        const codigoInput = document.getElementById('codigoBarra');
        const btnEscanear = document.getElementById('btnEscanearCodigo');
        const scannerOverlay = document.getElementById('scannerOverlay');
        const btnCerrarScanner = document.getElementById('btnCerrarScanner');
        const scannerViewport = document.getElementById('scannerViewport');
        const scannerMensaje = document.getElementById('scannerMensaje');
        let scannerActivo = false;

        function detenerScanner() {
            if (window.Quagga && scannerActivo) {
                window.Quagga.stop();
                scannerActivo = false;
            }
            scannerOverlay.classList.remove('activo');
        }

        function iniciarScanner() {
            if (!window.Quagga) {
                alert('No se pudo cargar el lector de c√≥digos. Us√° HTTPS o localhost.');
                return;
            }
            scannerOverlay.classList.add('activo');
            if (scannerMensaje) scannerMensaje.textContent = '';

            window.Quagga.init({
                inputStream: {
                    type: 'LiveStream',
                    target: scannerViewport,
                    constraints: {
                        facingMode: 'environment',
                        width: { ideal: 1280, min: 640 },
                        height: { ideal: 720, min: 480 }
                    }
                },
                decoder: {
                    readers: ['ean_reader', 'ean_8_reader', 'upc_reader', 'upc_e_reader', 'code_128_reader'],
                    multiple: false
                },
                locate: true,
                numOfWorkers: navigator.hardwareConcurrency ? Math.min(4, navigator.hardwareConcurrency) : 2,
                frequency: 20
            }, function(err) {
                if (err) {
                    console.error(err);
                    if (scannerMensaje) scannerMensaje.textContent = 'No se pudo iniciar la c√°mara.';
                    detenerScanner();
                    return;
                }
                window.Quagga.start();
                scannerActivo = true;
            });

            let ultimoCodigo = null;
            window.Quagga.offDetected();
            window.Quagga.onDetected(function(result) {
                if (!result || !result.codeResult || !result.codeResult.code) return;
                var codigo = String(result.codeResult.code).trim();
                if (!codigo || codigo === ultimoCodigo) return;
                ultimoCodigo = codigo;

                codigoInput.value = codigo;
                if (scannerMensaje) scannerMensaje.textContent = 'C√≥digo le√≠do: ' + codigo;
                if (scannerMensaje) scannerMensaje.style.color = '#90EE90';
                detenerScanner();
                setTimeout(function() { ultimoCodigo = null; }, 2000);
            });
        }

        btnEscanear.addEventListener('click', iniciarScanner);
        btnCerrarScanner.addEventListener('click', detenerScanner);
        scannerOverlay.addEventListener('click', function(e) {
            if (e.target === scannerOverlay) detenerScanner();
        });
    </script>
</body>
</html>
