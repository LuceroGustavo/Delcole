<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${titulo}">Agregar producto</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link th:href="@{/css/app.css}" rel="stylesheet">
    <style>
        .scanner-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1050;
        }
        .scanner-overlay.activo { display: flex; }
        .scanner-modal {
            background: #000;
            border-radius: 8px;
            max-width: 500px;
            width: 100%;
            padding: 0.5rem;
            color: #fff;
        }
        #scannerViewport { width: 100%; max-height: 50vh; }
    </style>
</head>
<body class="bg-light">
    <div th:replace="~{fragments/navbar :: nav}"></div>
    <main class="container">
        <a th:href="@{/productos}" class="btn btn-link btn-sm text-muted text-decoration-none p-0 mb-2">‚Üê Volver a productos</a>
        <h4 class="mb-4" th:text="${titulo}">Agregar producto</h4>
        <form th:action="@{/api/productos}" th:object="${producto}" method="post" id="formProducto">
            <input type="hidden" id="productoId" th:name="id" th:value="${producto.id}" />
            <input type="hidden" id="csrfToken" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <div class="mb-3">
                <label class="form-label">C√≥digo de barras (opcional)</label>
                <div class="input-group">
                    <input type="text" id="codigoBarra" class="form-control form-control-lg" th:field="*{codigoBarra}" placeholder="Escanear o escribir el c√≥digo">
                    <button type="button" id="btnEscanearCodigo" class="btn btn-outline-primary">üì∑ Escanear</button>
                </div>
                <div class="form-text small">Si la c√°mara no lee bien, us√° una app de escaneo y peg√° el c√≥digo ac√°.</div>
            </div>
            <div class="mb-3">
                <label class="form-label">Descripci√≥n / Nombre *</label>
                <input type="text" class="form-control form-control-lg" th:field="*{nombre}" required placeholder="Ej: CEPITA NARANJA 1LT">
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Marca</label>
                    <select id="selectMarca" class="form-select form-control-lg" aria-label="Marca">
                        <option value="">‚Äî Cargando... ‚Äî</option>
                    </select>
                    <div id="wrapMarcaNueva" class="mt-1" style="display: none;">
                        <input type="text" id="inputMarcaNueva" class="form-control form-control-lg" placeholder="Ej: COCA COLA">
                    </div>
                    <input type="hidden" name="marca" id="marca" th:value="${producto.marca}">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Rubro</label>
                    <select id="selectRubro" class="form-select form-control-lg" aria-label="Rubro">
                        <option value="">‚Äî Cargando... ‚Äî</option>
                    </select>
                    <div id="wrapRubroNueva" class="mt-1" style="display: none;">
                        <input type="text" id="inputRubroNueva" class="form-control form-control-lg" placeholder="Ej: BEBIDAS, COMIDA">
                    </div>
                    <input type="hidden" name="rubro" id="rubro" th:value="${producto.rubro}">
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Costo (precio de compra)</label>
                    <input type="number" step="0.01" class="form-control form-control-lg" th:field="*{precioCompra}" placeholder="0.00">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Precio de venta *</label>
                    <input type="number" step="0.01" class="form-control form-control-lg" th:field="*{precioVenta}" required placeholder="0.00">
                </div>
            </div>
            <div class="row">
                <div class="col-6 mb-3">
                    <label class="form-label">Stock</label>
                    <input type="number" class="form-control form-control-lg" th:field="*{stockActual}" min="0" placeholder="0">
                </div>
                <div class="col-6 mb-3">
                    <label class="form-label">Stock m√≠n.</label>
                    <input type="number" class="form-control form-control-lg" th:field="*{stockMinimo}" min="0" placeholder="0">
                </div>
            </div>
            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                <a th:href="@{/productos}" class="btn btn-outline-secondary btn-lg">Cancelar</a>
                <button type="submit" class="btn btn-success btn-lg">Guardar</button>
            </div>
        </form>
    </main>

    <!-- Overlay esc√°ner para c√≥digo de barras -->
    <div id="scannerOverlay" class="scanner-overlay">
        <div class="scanner-modal">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="fw-semibold">Escanear c√≥digo de barras</span>
                <button type="button" id="btnCerrarScanner" class="btn btn-sm btn-light">Cerrar</button>
            </div>
            <div id="scannerMensaje" class="small mb-1" style="min-height: 1.2em;"></div>
            <div id="scannerViewport"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/@ericblade/quagga2/dist/quagga.js"></script>
    <script>
        // --- Men√∫s desplegables Marca y Rubro ---
        const VALUE_NUEVA = '_nueva_';
        const selectMarca = document.getElementById('selectMarca');
        const selectRubro = document.getElementById('selectRubro');
        const wrapMarcaNueva = document.getElementById('wrapMarcaNueva');
        const wrapRubroNueva = document.getElementById('wrapRubroNueva');
        const inputMarcaNueva = document.getElementById('inputMarcaNueva');
        const inputRubroNueva = document.getElementById('inputRubroNueva');
        const hiddenMarca = document.getElementById('marca');
        const hiddenRubro = document.getElementById('rubro');

        function setMarcaVal(v) { hiddenMarca.value = v || ''; }
        function setRubroVal(v) { hiddenRubro.value = v || ''; }

        function rellenarSelect(select, opciones, valorInicial, optNuevaLabel) {
            select.innerHTML = '';
            const vacio = document.createElement('option');
            vacio.value = '';
            vacio.textContent = '‚Äî Sin especificar ‚Äî';
            select.appendChild(vacio);
            (opciones || []).forEach(function(m) {
                const opt = document.createElement('option');
                opt.value = m;
                opt.textContent = m;
                select.appendChild(opt);
            });
            const optNueva = document.createElement('option');
            optNueva.value = VALUE_NUEVA;
            optNueva.textContent = optNuevaLabel;
            select.appendChild(optNueva);

            var valor = (valorInicial || '').trim();
            if (valor && !opciones.includes(valor)) {
                var extra = document.createElement('option');
                extra.value = valor;
                extra.textContent = valor;
                select.insertBefore(extra, optNueva);
            }
            if (valor) {
                select.value = valor;
            } else {
                select.value = '';
            }
        }

        function actualizarVisibilidadNueva(select, wrap, input, setVal) {
            if (select.value === VALUE_NUEVA) {
                wrap.style.display = 'block';
                setVal(input.value || '');
            } else {
                wrap.style.display = 'none';
                setVal(select.value || '');
            }
        }

        Promise.all([
            fetch('/api/productos/marcas').then(function(r) { return r.json(); }),
            fetch('/api/productos/rubros').then(function(r) { return r.json(); })
        ]).then(function(res) {
            var marcas = res[0] || [];
            var rubros = res[1] || [];
            var marcaInicial = (hiddenMarca && hiddenMarca.value) ? hiddenMarca.value.trim() : '';
            var rubroInicial = (hiddenRubro && hiddenRubro.value) ? hiddenRubro.value.trim() : '';

            rellenarSelect(selectMarca, marcas, marcaInicial, '‚Äî Nueva marca... ‚Äî');
            rellenarSelect(selectRubro, rubros, rubroInicial, '‚Äî Nuevo rubro... ‚Äî');

            if (marcaInicial && !marcas.includes(marcaInicial)) {
                selectMarca.value = marcaInicial;
            }
            if (rubroInicial && !rubros.includes(rubroInicial)) {
                selectRubro.value = rubroInicial;
            }

            actualizarVisibilidadNueva(selectMarca, wrapMarcaNueva, inputMarcaNueva, setMarcaVal);
            actualizarVisibilidadNueva(selectRubro, wrapRubroNueva, inputRubroNueva, setRubroVal);

            if (selectMarca.value === VALUE_NUEVA) inputMarcaNueva.value = marcaInicial;
            if (selectRubro.value === VALUE_NUEVA) inputRubroNueva.value = rubroInicial;
        }).catch(function() {
            selectMarca.innerHTML = '<option value="">‚Äî Error al cargar ‚Äî</option><option value="' + VALUE_NUEVA + '">‚Äî Nueva marca... ‚Äî</option>';
            selectRubro.innerHTML = '<option value="">‚Äî Error al cargar ‚Äî</option><option value="' + VALUE_NUEVA + '">‚Äî Nuevo rubro... ‚Äî</option>';
        });

        selectMarca.addEventListener('change', function() {
            actualizarVisibilidadNueva(selectMarca, wrapMarcaNueva, inputMarcaNueva, setMarcaVal);
            if (selectMarca.value === VALUE_NUEVA) inputMarcaNueva.focus();
        });
        selectRubro.addEventListener('change', function() {
            actualizarVisibilidadNueva(selectRubro, wrapRubroNueva, inputRubroNueva, setRubroVal);
            if (selectRubro.value === VALUE_NUEVA) inputRubroNueva.focus();
        });
        inputMarcaNueva.addEventListener('input', function() { setMarcaVal(inputMarcaNueva.value); });
        inputRubroNueva.addEventListener('input', function() { setRubroVal(inputRubroNueva.value); });

        document.getElementById('formProducto').addEventListener('submit', function(e) {
            e.preventDefault();
            var marcaVal = (selectMarca.value === VALUE_NUEVA) ? (inputMarcaNueva.value || '').trim() : (selectMarca.value || '').trim();
            var rubroVal = (selectRubro.value === VALUE_NUEVA) ? (inputRubroNueva.value || '').trim() : (selectRubro.value || '').trim();
            setMarcaVal(marcaVal);
            setRubroVal(rubroVal);

            const form = e.target;
            const idVal = form.productoId && form.productoId.value ? parseInt(form.productoId.value) : null;
            const data = {
                codigoBarra: (form.codigoBarra && form.codigoBarra.value) ? form.codigoBarra.value.trim() || null : null,
                nombre: (form.nombre && form.nombre.value) ? form.nombre.value.trim() : '',
                marca: marcaVal || null,
                rubro: rubroVal || null,
                precioCompra: form.precioCompra && form.precioCompra.value ? parseFloat(form.precioCompra.value) : null,
                precioVenta: form.precioVenta && form.precioVenta.value ? parseFloat(form.precioVenta.value) : 0,
                stockActual: form.stockActual && form.stockActual.value !== '' ? parseInt(form.stockActual.value, 10) : 0,
                stockMinimo: form.stockMinimo && form.stockMinimo.value !== '' ? parseInt(form.stockMinimo.value, 10) : 0,
                activo: true
            };
            if (idVal) data.id = idVal;
            var csrfTokenEl = document.getElementById('csrfToken');
            var headers = { 'Content-Type': 'application/json' };
            if (csrfTokenEl && csrfTokenEl.value) headers['X-CSRF-TOKEN'] = csrfTokenEl.value;
            fetch(form.action, { method: 'POST', headers: headers, body: JSON.stringify(data) })
            .then(function(r) {
                if (r.ok) return r.json();
                return r.text().then(function(t) { return Promise.reject(new Error(t || r.status)); });
            })
            .then(function() { window.location.href = idVal ? '/productos/' + idVal : '/productos'; })
            .catch(function(err) { alert('Error al guardar. Revis√° los datos.'); });
        });

        // --- Escanear c√≥digo de barras en nuevo producto ---
        const codigoInput = document.getElementById('codigoBarra');
        const btnEscanear = document.getElementById('btnEscanearCodigo');
        const scannerOverlay = document.getElementById('scannerOverlay');
        const btnCerrarScanner = document.getElementById('btnCerrarScanner');
        const scannerViewport = document.getElementById('scannerViewport');
        const scannerMensaje = document.getElementById('scannerMensaje');
        let scannerActivo = false;

        function detenerScanner() {
            if (window.Quagga && scannerActivo) {
                window.Quagga.stop();
                scannerActivo = false;
            }
            scannerOverlay.classList.remove('activo');
        }

        function iniciarScanner() {
            if (!window.Quagga) {
                alert('No se pudo cargar el lector de c√≥digos. Us√° HTTPS o localhost.');
                return;
            }
            scannerOverlay.classList.add('activo');
            if (scannerMensaje) scannerMensaje.textContent = '';

            window.Quagga.init({
                inputStream: {
                    type: 'LiveStream',
                    target: scannerViewport,
                    constraints: {
                        facingMode: 'environment',
                        width: { ideal: 1280, min: 640 },
                        height: { ideal: 720, min: 480 }
                    }
                },
                decoder: {
                    readers: ['ean_reader', 'ean_8_reader', 'upc_reader', 'upc_e_reader', 'code_128_reader'],
                    multiple: false
                },
                locate: true,
                numOfWorkers: navigator.hardwareConcurrency ? Math.min(4, navigator.hardwareConcurrency) : 2,
                frequency: 20
            }, function(err) {
                if (err) {
                    console.error(err);
                    if (scannerMensaje) scannerMensaje.textContent = 'No se pudo iniciar la c√°mara.';
                    detenerScanner();
                    return;
                }
                window.Quagga.start();
                scannerActivo = true;
            });

            let ultimoCodigo = null;
            window.Quagga.offDetected();
            window.Quagga.onDetected(function(result) {
                if (!result || !result.codeResult || !result.codeResult.code) return;
                var codigo = String(result.codeResult.code).trim();
                if (!codigo || codigo === ultimoCodigo) return;
                ultimoCodigo = codigo;

                codigoInput.value = codigo;
                if (scannerMensaje) scannerMensaje.textContent = 'C√≥digo le√≠do: ' + codigo;
                if (scannerMensaje) scannerMensaje.style.color = '#90EE90';
                detenerScanner();
                setTimeout(function() { ultimoCodigo = null; }, 2000);
            });
        }

        btnEscanear.addEventListener('click', iniciarScanner);
        btnCerrarScanner.addEventListener('click', detenerScanner);
        scannerOverlay.addEventListener('click', function(e) {
            if (e.target === scannerOverlay) detenerScanner();
        });
    </script>
</body>
</html>
