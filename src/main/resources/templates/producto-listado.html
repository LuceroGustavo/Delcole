<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${titulo} + ' - Kiosco Delcole'">Productos - Kiosco Delcole</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link th:href="@{/css/app.css}" rel="stylesheet">
    <style>
        .scanner-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1050;
        }
        .scanner-overlay.activo { display: flex; }
        .scanner-modal {
            background: #000;
            border-radius: 8px;
            max-width: 500px;
            width: 100%;
            padding: 0.5rem;
            color: #fff;
        }
        #scannerViewportListado { width: 100%; max-height: 50vh; }
        .fila-producto { display: flex; align-items: center; gap: 0.5rem; padding: 0.6rem 0; border-bottom: 1px solid rgba(0,0,0,.08); flex-wrap: wrap; }
        .fila-producto .nombre-producto { flex: 1; min-width: 0; font-weight: 600; overflow: hidden; text-overflow: ellipsis; }
        .fila-producto .precio-producto { color: var(--delcole-success, #198754); font-weight: 700; white-space: nowrap; }
        .fila-producto .stock-producto { font-weight: 500; min-width: 2rem; text-align: right; }
        .fila-producto .stock-producto.bajo { color: #dc3545; font-weight: 700; }
        .fila-producto .acciones { display: flex; gap: 0.35rem; flex-shrink: 0; }
        @media (min-width: 768px) {
            .fila-producto .nombre-producto { font-size: 1rem; }
        }
    </style>
</head>
<body class="bg-light">
    <div th:replace="~{fragments/navbar :: nav}"></div>
    <main class="container mt-4">
        <a th:href="@{/}" class="btn btn-link btn-sm text-muted text-decoration-none p-0 mb-2">‚Üê Inicio</a>
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4>Stock</h4>
            <a th:href="@{/productos/nuevo}" class="btn btn-success btn-sm">‚ûï Nuevo</a>
        </div>

        <input type="hidden" id="csrfTokenListado" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <!-- B√∫squeda y filtros -->
        <form id="formFiltrosProductos" th:action="@{/productos}" method="get" class="card card-body mb-4">
            <div class="row g-2 align-items-end">
                <div class="col-12 col-md">
                    <label class="form-label small mb-0">Nombre</label>
                    <input type="text" name="nombre" class="form-control" th:value="${filtroNombre}" placeholder="Buscar por nombre...">
                </div>
                <div class="col-12 col-md">
                    <label class="form-label small mb-0">C√≥digo de barras</label>
                    <div class="input-group">
                        <input type="text" name="codigoBarra" id="inputCodigoBarraListado" class="form-control" th:value="${codigoNoEncontrado}" placeholder="Escanear o pegar c√≥digo">
                        <button type="button" id="btnEscanearListado" class="btn btn-outline-primary" title="Escanear c√≥digo de barras">üì∑ Escanear</button>
                    </div>
                </div>
                <div class="col-6 col-md">
                    <label class="form-label small mb-0">Marca</label>
                    <select name="marca" class="form-select">
                        <option value="">Todas</option>
                        <option th:each="m : ${marcas}" th:value="${m}" th:text="${m}" th:selected="${m == filtroMarca}"></option>
                    </select>
                </div>
                <div class="col-6 col-md">
                    <label class="form-label small mb-0">Rubro</label>
                    <select name="rubro" class="form-select">
                        <option value="">Todos</option>
                        <option th:each="r : ${rubros}" th:value="${r}" th:text="${r}" th:selected="${r == filtroRubro}"></option>
                    </select>
                </div>
                <div class="col-auto">
                    <div class="form-check mb-0">
                        <input type="checkbox" name="soloStockBajo" value="true" class="form-check-input" id="cbStockBajo" th:checked="${filtroSoloStockBajo}">
                        <label class="form-check-label small" for="cbStockBajo">Solo stock bajo</label>
                    </div>
                </div>
                <div class="col-12 col-md-auto d-flex gap-1">
                    <button type="submit" class="btn btn-primary">Buscar</button>
                    <a th:href="@{/productos}" class="btn btn-outline-secondary">Limpiar</a>
                </div>
            </div>
            <p th:if="${codigoNoEncontrado}" class="text-danger small mb-0 mt-2">C√≥digo "<span th:text="${codigoNoEncontrado}"></span>" no encontrado.</p>
        </form>
        
        <div th:if="${#lists.isEmpty(productos)}" class="alert alert-info">
            <span th:if="${filtrosAplicados}">Ning√∫n producto coincide con los filtros.</span>
            <span th:unless="${filtrosAplicados}">No hay productos cargados. <a th:href="@{/productos/nuevo}">Agreg√° uno</a>.</span>
        </div>
        <div th:if="${!#lists.isEmpty(productos)}" th:unless="${codigoNoEncontrado}" class="alert alert-secondary py-2 small" th:text="'Mostrando ' + ${#lists.size(productos)} + ' producto(s).'">Mostrando N productos.</div>
        
        <ul class="list-group list-group-flush" th:if="${!#lists.isEmpty(productos)}">
            <li th:each="p : ${productos}" class="list-group-item px-0">
                <div class="fila-producto">
                    <span class="nombre-producto" th:text="${p.nombre}">Nombre</span>
                    <span class="precio-producto" th:text="'$ ' + ${p.precioVenta}">$ 0</span>
                    <span class="stock-producto" th:classappend="${p.stockBajo} ? 'bajo' : ''" th:text="${p.stockActual}">0</span>
                    <span th:if="${p.stockBajo}" class="badge bg-danger">Bajo</span>
                    <div class="acciones">
                        <a th:href="@{/productos/{id}(id=${p.id})}" class="btn btn-sm btn-outline-primary">Ver</a>
                        <button type="button" class="btn btn-sm btn-success btn-agregar-stock" th:data-id="${p.id}" th:data-nombre="${p.nombre}">+ Stock</button>
                    </div>
                </div>
                <div class="d-none d-md-block small text-muted mt-0 pt-0">
                    <span th:if="${p.codigoBarra}" th:text="'(' + ${p.codigoBarra} + ')'">(c√≥digo)</span>
                    <span class="ms-1" th:text="${(p.marca != null and !#strings.isEmpty(p.marca)) ? (' ¬∑ ' + p.marca) : ' ¬∑ Sin marca'}">¬∑ Marca</span>
                    <span class="badge bg-secondary ms-1" th:text="${(p.rubro != null and !#strings.isEmpty(p.rubro)) ? p.rubro : 'Sin rubro'}">Rubro</span>
                </div>
            </li>
        </ul>
    </main>

    <!-- Overlay esc√°ner para c√≥digo de barras en listado -->
    <div id="scannerOverlayListado" class="scanner-overlay">
        <div class="scanner-modal">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="fw-semibold">Escanear c√≥digo de barras</span>
                <button type="button" id="btnCerrarScannerListado" class="btn btn-sm btn-light">Cerrar</button>
            </div>
            <div id="scannerMensajeListado" class="small mb-1" style="min-height: 1.2em;"></div>
            <div id="scannerViewportListado"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/@ericblade/quagga2/dist/quagga.js"></script>
    <script>
        (function() {
            var formFiltros = document.getElementById('formFiltrosProductos');
            var inputCodigo = document.getElementById('inputCodigoBarraListado');
            var btnEscanear = document.getElementById('btnEscanearListado');
            var overlay = document.getElementById('scannerOverlayListado');
            var btnCerrar = document.getElementById('btnCerrarScannerListado');
            var viewport = document.getElementById('scannerViewportListado');
            var mensaje = document.getElementById('scannerMensajeListado');
            var scannerActivo = false;

            function detenerScanner() {
                if (window.Quagga && scannerActivo) {
                    window.Quagga.stop();
                    scannerActivo = false;
                }
                if (overlay) overlay.classList.remove('activo');
            }

            function iniciarScanner() {
                if (!window.Quagga) {
                    alert('No se pudo cargar el lector de c√≥digos. Us√° HTTPS o localhost.');
                    return;
                }
                if (overlay) overlay.classList.add('activo');
                if (mensaje) mensaje.textContent = '';
                window.Quagga.init({
                    inputStream: {
                        type: 'LiveStream',
                        target: viewport,
                        constraints: { facingMode: 'environment', width: { ideal: 1280, min: 640 }, height: { ideal: 720, min: 480 } }
                    },
                    decoder: { readers: ['ean_reader', 'ean_8_reader', 'upc_reader', 'upc_e_reader', 'code_128_reader'], multiple: false },
                    locate: true,
                    numOfWorkers: navigator.hardwareConcurrency ? Math.min(4, navigator.hardwareConcurrency) : 2,
                    frequency: 20
                }, function(err) {
                    if (err) {
                        if (mensaje) mensaje.textContent = 'No se pudo iniciar la c√°mara.';
                        detenerScanner();
                        return;
                    }
                    window.Quagga.start();
                    scannerActivo = true;
                });
                var ultimoCodigo = null;
                window.Quagga.offDetected();
                window.Quagga.onDetected(function(result) {
                    if (!result || !result.codeResult || !result.codeResult.code) return;
                    var codigo = String(result.codeResult.code).trim();
                    if (!codigo || codigo === ultimoCodigo) return;
                    ultimoCodigo = codigo;
                    if (inputCodigo) inputCodigo.value = codigo;
                    if (mensaje) { mensaje.textContent = 'C√≥digo: ' + codigo; mensaje.style.color = '#90EE90'; }
                    detenerScanner();
                    if (formFiltros) {
                        formFiltros.querySelector('input[name="nombre"]').value = '';
                        formFiltros.querySelector('select[name="marca"]').value = '';
                        formFiltros.querySelector('select[name="rubro"]').value = '';
                        var cb = formFiltros.querySelector('input[name="soloStockBajo"]');
                        if (cb) cb.checked = false;
                        formFiltros.submit();
                    }
                    setTimeout(function() { ultimoCodigo = null; }, 2000);
                });
            }

            if (btnEscanear) btnEscanear.addEventListener('click', iniciarScanner);
            if (btnCerrar) btnCerrar.addEventListener('click', detenerScanner);
            if (overlay) overlay.addEventListener('click', function(e) { if (e.target === overlay) detenerScanner(); });
        })();
        document.querySelectorAll('.btn-agregar-stock').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var id = this.getAttribute('data-id');
                var nombre = this.getAttribute('data-nombre') || 'Producto';
                var cant = prompt('¬øCu√°ntas unidades sumar a \"' + nombre + '\"?', '1');
                if (cant == null || cant === '') return;
                var n = parseInt(cant, 10);
                if (isNaN(n) || n < 1) { alert('Ingres√° un n√∫mero positivo.'); return; }
                var csrf = document.getElementById('csrfTokenListado');
                var headers = { 'Content-Type': 'application/json' };
                if (csrf && csrf.value) headers['X-CSRF-TOKEN'] = csrf.value;
                fetch('/api/productos/' + id + '/stock/sumar', { method: 'POST', headers: headers, body: JSON.stringify({ cantidad: n }) })
                    .then(function(r) { if (r.ok) location.reload(); else return r.json().then(function(e) { alert(e.error || 'Error'); }); })
                    .catch(function() { alert('Error de conexi√≥n.'); });
            });
        });
    </script>
</body>
</html>
